#!/bin/bash

# Check if application is run as root
if [ "$EUID" -ne 0 ]
  then echo "Please run application as root"
  exit
fi

# Check if /opt/vdtg-rmm application folder exists else stop code execution
if [ -d "/opt/vdtg-rmm" ]
then

    # Move to vdtg-rmm application folder
    cd /opt/vdtg-rmm

    # Check if daemon file is executable
    if [ ! -x /opt/vdtg-rmm/vdtg-rmm-daemon ]
    then
        # Make vdtg-rmm daemon executable
        chmod +x /opt/vdtg-rmm/vdtg-rmm-daemon
    fi

    # Add vdtg-rmm-daemon to crontab
    if ! crontab -l | grep -q '/opt/vdtg-rmm/vdtg-rmm-daemon'
    then
        # Add vdtg-rmm-daemon to crontab and run every day at 06:00
        (crontab -l ; echo "0 6 * * * /opt/vdtg-rmm/vdtg-rmm-daemon") | crontab -
    fi

    # Check if file /opt/vdtg-rmm/sources.list is different from /etc/apt/sources.list
    if ! cmp -s /opt/vdtg-rmm/sources.list /etc/apt/sources.list
    then

        # Backup current sources.list to sources.list.bak.current date
        mv /etc/apt/sources.list /etc/apt/sources.list.bak.$(date +%Y%m%d%H%M%S)

        # Copy VDTG Mirror sources.list to /etc/apt
        cp /opt/vdtg-rmm/sources.list /etc/apt/sources.list

    fi

    # Clear the apt cache.
    apt clean

    # Update packages
    apt update

    # Install package updates
    apt upgrade -y

    # Check if git is installed
    if ! dpkg -l | grep -q git
    then
        # Install git
        apt install -y git
    fi

    # Check if net-tools is installed
    if ! dpkg -l | grep -q net-tools
    then
        # Install net-tools
        apt install -y net-tools
    fi

    # Get locale from vdtg-rmm.config file ignore all lines starting with '#' because they are comments
    locale=$(grep -v '^#' /opt/vdtg-rmm/vdtg-rmm.config | grep -i 'locale' | awk -F'=' '{print $2}')

    # Check if language-pack-$locale is installed
    if ! dpkg -l | grep -q language-pack-$locale
    then
        # Install language-pack-$locale
        apt install -y language-pack-$locale
    fi

    # If locale is nl then set local to Dutch
    if [ "$locale" == "nl" ]
    then
        # Set local to Dutch
        update-locale LANG=nl_NL.utf-8 LC_MESSAGES=POSIX
    fi

    # Get install_dnsmasq from vdtg-rmm.config file ignore all lines starting with '#' because they are comments
    install_dnsmasq=$(grep -v '^#' /opt/vdtg-rmm/vdtg-rmm.config | grep -i 'install_dnsmasq' | awk -F'=' '{print $2}')

    # Check if install dnsmasq is true
    if [ "$install_dnsmasq" == "true" ]
    then
        # Check if dnsmasq is installed
        if ! dpkg -l | grep -q dnsmasq
        then

            # Disable systemd-resolved
            systemctl stop systemd-resolved
            systemctl disable systemd-resolved
    
            # Install dnsmasq
            apt install -y dnsmasq

        fi
    fi

else
    echo "Application not installed at /opt/vdtg-rmm. Please install application in the correct folder."
    exit
fi
